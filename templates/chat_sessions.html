<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Sessions - VeritasAI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            500: '#667eea',
                            600: '#764ba2',
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-slate-50 min-h-screen">
    <!-- Header -->
    <div class="bg-white border-b border-slate-200 px-6 py-4 flex justify-between items-center shadow-sm">
        <div class="flex items-center gap-4">
            <h1 class="text-2xl font-bold text-slate-800">Chat Sessions</h1>
        </div>
        <div class="flex items-center gap-4">
            <a href="/documents.html" class="text-slate-600 hover:text-slate-800 font-medium">Documents</a>
            <button id="logoutBtn" class="px-4 py-2 text-slate-600 hover:text-slate-800 font-medium">Logout</button>
        </div>
    </div>

    <div class="max-w-6xl mx-auto px-6 py-8">
        <!-- Create New Session -->
        <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
            <h2 class="text-lg font-semibold text-slate-800 mb-4">New Conversation</h2>
            <form id="createSessionForm" class="flex gap-3">
                <input 
                    type="text" 
                    id="sessionTitle"
                    placeholder="Enter conversation title (optional)"
                    class="flex-1 px-4 py-2 border-2 border-slate-200 rounded-lg text-sm focus:outline-none focus:border-[#667eea] focus:ring-4 focus:ring-[#667eea]/10"
                >
                <button 
                    type="submit"
                    id="createBtn"
                    class="px-6 py-2 bg-gradient-to-r from-[#667eea] to-[#764ba2] text-white rounded-lg font-semibold hover:-translate-y-0.5 hover:shadow-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none"
                >
                    Create Session
                </button>
            </form>
            <div id="createMessage" class="hidden mt-3 text-sm"></div>
        </div>

        <!-- Sessions List -->
        <div id="sessionsList" class="space-y-3">
            <div class="text-center py-12 text-slate-400">
                Loading sessions...
            </div>
        </div>
    </div>

    <script src="/static/js/api.js"></script>
    <script>
        // Check authentication
        if (!TokenManager.isAuthenticated()) {
            window.location.href = '/login.html';
        }

        // Load sessions on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadSessions();
            
            // Create session form
            document.getElementById('createSessionForm').addEventListener('submit', handleCreateSession);
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
        });

        async function loadSessions() {
            try {
                const data = await ChatSessionsAPI.list();
                renderSessions(data.results || data);
            } catch (error) {
                showError('Failed to load sessions: ' + error.message);
            }
        }

        function renderSessions(sessions) {
            const container = document.getElementById('sessionsList');
            
            if (sessions.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12 text-slate-400">
                        No chat sessions yet. Create your first conversation to get started!
                    </div>
                `;
                return;
            }

            container.innerHTML = sessions.map(session => `
                <div class="bg-white rounded-xl shadow-sm p-5 hover:shadow-md transition cursor-pointer" onclick="openSession(${session.id})">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h3 class="font-semibold text-slate-800 mb-2">
                                ${session.title || 'New Conversation'}
                            </h3>
                            <div class="text-xs text-slate-500 space-y-1">
                                <div>Messages: ${session.message_count || 0}</div>
                                <div>Last message: ${session.last_message_at ? formatDate(session.last_message_at) : 'Never'}</div>
                                ${session.model_name ? `<div>Model: ${session.model_name}</div>` : ''}
                            </div>
                        </div>
                        <button 
                            onclick="event.stopPropagation(); deleteSession(${session.id})"
                            class="text-red-500 hover:text-red-700 ml-4"
                            title="Delete"
                        >
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        async function handleCreateSession(e) {
            e.preventDefault();
            const title = document.getElementById('sessionTitle').value.trim() || 'New Conversation';
            const createBtn = document.getElementById('createBtn');
            
            createBtn.disabled = true;
            createBtn.textContent = 'Creating...';
            
            try {
                const session = await ChatSessionsAPI.create(title);
                showMessage('Session created successfully!', 'success');
                document.getElementById('sessionTitle').value = '';
                loadSessions();
                
                // Auto-open new session
                setTimeout(() => openSession(session.id), 500);
            } catch (error) {
                showMessage('Failed to create session: ' + error.message, 'error');
            } finally {
                createBtn.disabled = false;
                createBtn.textContent = 'Create Session';
            }
        }

        function openSession(sessionId) {
            window.location.href = `/chat.html?session_id=${sessionId}`;
        }

        async function deleteSession(id) {
            if (!confirm('Are you sure you want to delete this session?')) return;
            
            try {
                await ChatSessionsAPI.delete(id);
                showMessage('Session deleted successfully', 'success');
                loadSessions();
            } catch (error) {
                showMessage('Delete failed: ' + error.message, 'error');
            }
        }

        async function handleLogout() {
            await AuthAPI.logout();
            window.location.href = '/login.html';
        }

        function showMessage(message, type) {
            const messageEl = document.getElementById('createMessage');
            messageEl.textContent = message;
            messageEl.className = `mt-3 text-sm ${type === 'error' ? 'text-red-600' : 'text-green-600'}`;
            messageEl.classList.remove('hidden');
            setTimeout(() => messageEl.classList.add('hidden'), 5000);
        }

        function formatDate(dateString) {
            if (!dateString) return 'Never';
            const date = new Date(dateString);
            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);
            
            if (minutes < 1) return 'Just now';
            if (minutes < 60) return `${minutes}m ago`;
            if (hours < 24) return `${hours}h ago`;
            if (days < 7) return `${days}d ago`;
            return date.toLocaleDateString();
        }

        // Make functions global
        window.openSession = openSession;
        window.deleteSession = deleteSession;
    </script>
</body>
</html>

