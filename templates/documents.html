<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Documents - VeritasAI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            500: '#667eea',
                            600: '#764ba2',
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-slate-50 min-h-screen">
    <!-- Header -->
    <div class="bg-white border-b border-slate-200 px-6 py-4 flex justify-between items-center shadow-sm">
        <div class="flex items-center gap-4">
            <h1 class="text-2xl font-bold text-slate-800">Documents</h1>
        </div>
        <div class="flex items-center gap-4">
            <a href="/chat_sessions.html" class="text-slate-600 hover:text-slate-800 font-medium">Chat Sessions</a>
            <button id="logoutBtn" class="px-4 py-2 text-slate-600 hover:text-slate-800 font-medium">Logout</button>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-6 py-8">
        <!-- Upload Section -->
        <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
            <h2 class="text-lg font-semibold text-slate-800 mb-4">Upload Document</h2>
            <form id="uploadForm" class="flex gap-3 items-start">
                <div class="flex-1">
                    <input 
                        type="file" 
                        id="fileInput"
                        accept=".pdf,.docx,.txt,.md"
                        class="w-full px-4 py-2.5 border-2 border-slate-200 rounded-lg text-sm focus:outline-none focus:border-[#667eea] focus:ring-4 focus:ring-[#667eea]/10"
                    >
                    <p class="text-xs text-slate-500 mt-1">Supported: PDF, DOCX, TXT, MD (Max 10MB)</p>
                </div>
                <button 
                    type="submit"
                    id="uploadBtn"
                    class="px-6 py-2.5 bg-gradient-to-r from-[#667eea] to-[#764ba2] text-white rounded-lg font-semibold hover:-translate-y-0.5 hover:shadow-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none whitespace-nowrap"
                    style="height: 42px; margin-top: 0;"
                >
                    Upload
                </button>
            </form>
            <div id="uploadMessage" class="hidden mt-3 text-sm"></div>
        </div>

        <!-- Filters -->
        <div class="bg-white rounded-xl shadow-sm p-4 mb-6 flex gap-4 items-center flex-wrap">
            <input 
                type="text" 
                id="searchInput"
                placeholder="Search documents..."
                class="flex-1 min-w-[200px] px-4 py-2 border-2 border-slate-200 rounded-lg text-sm focus:outline-none focus:border-[#667eea] focus:ring-4 focus:ring-[#667eea]/10"
            >
            <select 
                id="statusFilter"
                class="px-4 py-2 border-2 border-slate-200 rounded-lg text-sm focus:outline-none focus:border-[#667eea] focus:ring-4 focus:ring-[#667eea]/10"
            >
                <option value="">All Status</option>
                <option value="pending">Pending</option>
                <option value="processing">Processing</option>
                <option value="completed">Completed</option>
                <option value="failed">Failed</option>
            </select>
            <button 
                id="refreshBtn"
                class="px-4 py-2 bg-slate-100 text-slate-700 rounded-lg font-medium hover:bg-slate-200 transition"
            >
                Refresh
            </button>
        </div>

        <!-- Documents List -->
        <div id="documentsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <div class="col-span-full text-center py-12 text-slate-400">
                Loading documents...
            </div>
        </div>

        <!-- Pagination -->
        <div id="pagination" class="mt-6 flex justify-center gap-2 hidden"></div>
    </div>

    <script src="/static/js/api.js"></script>
    <script>
        let currentPage = 1;
        let currentFilters = {};

        // Check authentication
        if (!TokenManager.isAuthenticated()) {
            window.location.href = '/login.html';
        }

        // Load documents on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadDocuments();
            
            // Upload form
            document.getElementById('uploadForm').addEventListener('submit', handleUpload);
            
            // Search and filters
            document.getElementById('searchInput').addEventListener('input', debounce(handleSearch, 500));
            document.getElementById('statusFilter').addEventListener('change', handleFilter);
            document.getElementById('refreshBtn').addEventListener('click', () => loadDocuments());
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
        });

        async function loadDocuments(page = 1) {
            currentPage = page;
            const params = { page, page_size: 12, ...currentFilters };
            
            try {
                const data = await DocumentsAPI.list(params);
                renderDocuments(data.results || data);
                renderPagination(data);
            } catch (error) {
                showError('Failed to load documents: ' + error.message);
            }
        }

        function renderDocuments(documents) {
            const container = document.getElementById('documentsList');
            
            if (documents.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-12 text-slate-400">
                        No documents found. Upload your first document to get started!
                    </div>
                `;
                return;
            }

            container.innerHTML = documents.map(doc => `
                <div class="bg-white rounded-xl shadow-sm p-5 hover:shadow-md transition" data-document-id="${doc.id}">
                    <div class="flex justify-between items-start mb-3">
                        <h3 class="font-semibold text-slate-800 truncate flex-1" title="${doc.name}">
                            ${doc.name}
                        </h3>
                        <button 
                            onclick="deleteDocument(${doc.id})"
                            class="text-red-500 hover:text-red-700 ml-2"
                            title="Delete"
                        >
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <div class="mb-3">
                        <span class="inline-block px-2 py-1 rounded text-xs font-medium ${getStatusClass(doc.status)} status-badge">
                            ${doc.status}
                        </span>
                        ${doc.category ? `<span class="ml-2 text-xs text-slate-500">${doc.category}</span>` : ''}
                    </div>
                    
                    <div class="text-xs text-slate-500 mb-4">
                        <div>Size: ${formatFileSize(doc.file_size)}</div>
                        <div>Uploaded: ${formatDate(doc.created_at)}</div>
                    </div>
                    
                    <div class="action-button">
                        ${doc.status === 'completed' ? `
                            <a 
                                href="/chat.html?document_id=${doc.id}"
                                class="block w-full text-center px-4 py-2 bg-gradient-to-r from-[#667eea] to-[#764ba2] text-white rounded-lg font-medium hover:-translate-y-0.5 hover:shadow-lg transition"
                            >
                                Chat with Document
                            </a>
                        ` : `
                            <div class="text-center px-4 py-2 bg-slate-100 text-slate-500 rounded-lg text-sm">
                                Processing...
                            </div>
                        `}
                    </div>
                </div>
            `).join('');
            
            // Start polling for pending/processing documents
            documents.forEach(doc => {
                if (doc.status === 'pending' || doc.status === 'processing') {
                    startPollingDocument(doc.id);
                }
            });
        }

        function renderPagination(data) {
            const pagination = document.getElementById('pagination');
            if (!data.next && !data.previous) {
                pagination.classList.add('hidden');
                return;
            }
            
            pagination.classList.remove('hidden');
            pagination.innerHTML = `
                <button 
                    onclick="loadDocuments(${currentPage - 1})"
                    ${!data.previous ? 'disabled' : ''}
                    class="px-4 py-2 bg-white border border-slate-200 rounded-lg ${!data.previous ? 'opacity-50 cursor-not-allowed' : 'hover:bg-slate-50'}"
                >
                    Previous
                </button>
                <span class="px-4 py-2 text-slate-600">
                    Page ${currentPage}
                </span>
                <button 
                    onclick="loadDocuments(${currentPage + 1})"
                    ${!data.next ? 'disabled' : ''}
                    class="px-4 py-2 bg-white border border-slate-200 rounded-lg ${!data.next ? 'opacity-50 cursor-not-allowed' : 'hover:bg-slate-50'}"
                >
                    Next
                </button>
            `;
        }

        async function handleUpload(e) {
            e.preventDefault();
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                showMessage('Please select a file', 'error');
                return;
            }
            
            const uploadBtn = document.getElementById('uploadBtn');
            uploadBtn.disabled = true;
            uploadBtn.textContent = 'Uploading...';
            
            try {
                const result = await DocumentsAPI.upload(file);
                showMessage('Document uploaded successfully!', 'success');
                fileInput.value = '';
                
                // Reload documents immediately
                await loadDocuments();
                
                // If document is pending/processing, start polling for status updates
                if (result.document && (result.document.status === 'pending' || result.document.status === 'processing')) {
                    startPollingDocument(result.document.id);
                }
            } catch (error) {
                showMessage('Upload failed: ' + error.message, 'error');
            } finally {
                uploadBtn.disabled = false;
                uploadBtn.textContent = 'Upload';
            }
        }
        
        let pollingIntervals = new Map();
        
        function startPollingDocument(documentId) {
            // Clear existing polling for this document if any
            if (pollingIntervals.has(documentId)) {
                clearInterval(pollingIntervals.get(documentId));
            }
            
            let pollCount = 0;
            const maxPolls = 60; // Poll for max 5 minutes (60 * 5 seconds)
            
            const interval = setInterval(async () => {
                pollCount++;
                
                try {
                    const doc = await DocumentsAPI.get(documentId);
                    
                    // Update the specific document card
                    updateDocumentCard(doc);
                    
                    // If completed or failed, stop polling
                    if (doc.status === 'completed' || doc.status === 'failed') {
                        clearInterval(interval);
                        pollingIntervals.delete(documentId);
                    }
                    
                    // Stop polling after max attempts
                    if (pollCount >= maxPolls) {
                        clearInterval(interval);
                        pollingIntervals.delete(documentId);
                    }
                } catch (error) {
                    console.error('Error polling document status:', error);
                    // Stop polling on error
                    clearInterval(interval);
                    pollingIntervals.delete(documentId);
                }
            }, 5000); // Poll every 5 seconds
            
            pollingIntervals.set(documentId, interval);
        }
        
        function updateDocumentCard(doc) {
            // Find the document card and update it
            const container = document.getElementById('documentsList');
            const cards = container.querySelectorAll('[data-document-id]');
            
            cards.forEach(card => {
                if (parseInt(card.getAttribute('data-document-id')) === doc.id) {
                    // Update status badge
                    const statusBadge = card.querySelector('.status-badge');
                    if (statusBadge) {
                        statusBadge.textContent = doc.status;
                        statusBadge.className = `inline-block px-2 py-1 rounded text-xs font-medium ${getStatusClass(doc.status)} status-badge`;
                    }
                    
                    // Update action button
                    const actionBtn = card.querySelector('.action-button');
                    if (actionBtn) {
                        if (doc.status === 'completed') {
                            actionBtn.innerHTML = `
                                <a href="/chat.html?document_id=${doc.id}" class="block w-full text-center px-4 py-2 bg-gradient-to-r from-[#667eea] to-[#764ba2] text-white rounded-lg font-medium hover:-translate-y-0.5 hover:shadow-lg transition">
                                    Chat with Document
                                </a>
                            `;
                        } else {
                            actionBtn.innerHTML = `
                                <div class="text-center px-4 py-2 bg-slate-100 text-slate-500 rounded-lg text-sm">
                                    Processing...
                                </div>
                            `;
                        }
                    }
                }
            });
        }

        async function deleteDocument(id) {
            if (!confirm('Are you sure you want to delete this document?')) return;
            
            try {
                await DocumentsAPI.delete(id);
                showMessage('Document deleted successfully', 'success');
                loadDocuments();
            } catch (error) {
                showMessage('Delete failed: ' + error.message, 'error');
            }
        }

        function handleSearch(e) {
            const search = e.target.value.trim();
            currentFilters = { ...currentFilters, search: search || undefined };
            loadDocuments(1);
        }

        function handleFilter(e) {
            const status = e.target.value;
            currentFilters = { ...currentFilters, status: status || undefined };
            loadDocuments(1);
        }

        async function handleLogout() {
            await AuthAPI.logout();
            window.location.href = '/login.html';
        }

        function showMessage(message, type) {
            const messageEl = document.getElementById('uploadMessage');
            messageEl.textContent = message;
            messageEl.className = `mt-3 text-sm ${type === 'error' ? 'text-red-600' : 'text-green-600'}`;
            messageEl.classList.remove('hidden');
            setTimeout(() => messageEl.classList.add('hidden'), 5000);
        }

        function getStatusClass(status) {
            const classes = {
                pending: 'bg-yellow-100 text-yellow-800',
                processing: 'bg-blue-100 text-blue-800',
                completed: 'bg-green-100 text-green-800',
                failed: 'bg-red-100 text-red-800',
            };
            return classes[status] || 'bg-slate-100 text-slate-800';
        }

        function formatFileSize(bytes) {
            if (!bytes) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Make functions global for onclick handlers
        window.deleteDocument = deleteDocument;
        window.loadDocuments = loadDocuments;
    </script>
</body>
</html>
